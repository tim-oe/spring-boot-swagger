// https://flywaydb.org/
plugins {
    id 'org.flywaydb.flyway' version '6.4.0'
}

configurations {
    db
}

// https://discuss.gradle.org/t/skipping-a-systemtest-task-for-a-specific-submodule/13121
processTestResources.enabled = false
testClasses.enabled = false
test.enabled = false
spotbugsMain.enabled = false
spotbugsTest.enabled = false
pmdTest.enabled = false
compileTestJava.enabled = false
processResources.enabled = false
jar.enabled = false
bootJar.enabled = false
assemble.enabled = false
generateVersionInfo.enabled = false

dependencies {
    implementation group: 'org.mariadb.jdbc', name: 'mariadb-java-client'

    //to get ant.sql working
    db group: 'org.mariadb.jdbc', name: 'mariadb-java-client'
}

// https://flywaydb.org/getstarted/firststeps/gradle
// https://flywaydb.org/documentation/gradle/
flyway {
    url = "jdbc:mariadb://${db_host}:${db_port}/"
    user = "${db_username}"
    password = "${db_password}"
    schemas = ["${db_name}"]
    locations = ["filesystem:$projectDir/src/main/sql/schema",
                 "filesystem:$projectDir/src/main/sql/functions"]
}

/**
 * task to drop and reload the DB
 * https://docs.gradle.org/current/userguide/tutorial_using_tasks.html
 * need to quote the name to leverage dot notation
 */
task dbReset {
    description 'task to drop and reload the DB'
    dependsOn flywayClean,flywayMigrate

    doLast {
        ant.sql(classpath: configurations.db.asPath,
                driver: 'org.mariadb.jdbc.Driver',
                url: "jdbc:mariadb://${db_host}:${db_port}/${db_name}",
                userid: "${db_username}",
                password: "${db_password}",
                delimiter: ';;',
                delimitertype: 'normal'
        ) {
            transaction {
                fileset(dir: "$projectDir/src/main/sql/data") {
                    include(name: '*.sql')
                }
            }
            transaction {
                fileset(dir: "$project.gradle.gradleUserHomeDir") {
                    include(name: 'tec-custom.sql')
                }
            }
        }
    }
}